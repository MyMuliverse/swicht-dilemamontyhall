<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monty Hall v4.0 Plus</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; }
    h1,h2,h3 { color: #333; }
    .container { max-width: 900px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1);}
    input,button,select { margin:5px 0; padding:10px; border-radius:5px; border:1px solid #ccc; width:100%; }
    button { background:#007bff; color:#fff; cursor:pointer; }
    button:hover { background:#0056b3; }
    .hidden { display:none; }
    .doors { display:flex; justify-content:center; gap:15px; margin:20px 0; }
    .door { width:100px; height:150px; background:#d2b48c; border:3px solid #654321; border-radius:5px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px; }
    .door.open { background:#eee; }
    .door.goat { background:#ccc; }
    .door.prize { background:#ffd700; }
    .log { background:#f8f9fa; padding:10px; border-radius:5px; margin-top:10px; font-family:monospace; white-space:pre-wrap; }
  </style>
</head>
<body>
<div class="container">
  <h1>Simulador Monty Hall v4.0 Plus</h1>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <h2>Crear nueva sala</h2>
    <label>Organizaci√≥n:</label>
    <input id="orgName" placeholder="Ej: Universidad Central del Paraguay">
    <label>Taller / Workshop:</label>
    <input id="workshopName" placeholder="Ej: Workshop MBA 2">
    <button onclick="createRoom()">Crear Sala</button>
    <div id="admin-result"></div>
  </div>

  <!-- PLAYER -->
  <div id="view-play" class="hidden">
    <h2>Jugador / Equipo</h2>
    <div id="join-area">
      <label>Nombre del equipo:</label>
      <input id="teamName" placeholder="Ej: Equipo Alfa">
      <button onclick="joinTeam()">Unirse</button>
    </div>
    <div id="game-area" class="hidden">
      <h3>Juego</h3>
      <button onclick="startGame('A')">Modo A: Elegir entre 3 puertas</button>
      <button onclick="startGame('B')">Modo B: Monty revela cabras</button>
      <div id="doors-container" class="doors"></div>
      <div id="decision-area" class="hidden"></div>
      <div id="result-area"></div>
    </div>
  </div>

  <!-- HOST -->
  <div id="view-host" class="hidden">
    <h2>Dashboard del Instructor</h2>
    <button onclick="refreshDashboard()">Actualizar</button>
    <div id="host-result"></div>
  </div>

  <!-- SCREEN -->
  <div id="view-screen" class="hidden">
    <h2>Pantalla P√∫blica</h2>
    <button onclick="refreshScreen()">Actualizar</button>
    <div id="screen-result"></div>
  </div>
</div>

<script>
  // Par√°metros de URL
  const urlParams = new URLSearchParams(window.location.search);
  const view   = urlParams.get("view") || "admin";
  const roomId = urlParams.get("roomId") || "";
  const token  = urlParams.get("token") || "";
  let teamId = null;
  let playId = null;
  let startedAt = null;

  document.getElementById("view-" + view).classList.remove("hidden");

  // Sonidos
  const sndCar   = new Audio("Car.wav");
  const sndGoat  = new Audio("Goat.wav");
  const sndWin   = new Audio("Win.wav");
  const sndLose  = new Audio("Loses.wav");

  // === API helper ===
  function googleApi(name, payload, cb) {
    google.script.run.withSuccessHandler(cb).withFailureHandler(err => {
      alert("Error: " + err.message);
      console.error(err);
    })[name](...(Array.isArray(payload)?payload:[payload]));
  }

  // === ADMIN ===
  function createRoom() {
    const orgName = document.getElementById("orgName").value;
    const workshopName = document.getElementById("workshopName").value;
    googleApi("apiCreateRoom", { orgName, workshopName }, res => {
      document.getElementById("admin-result").innerHTML = `
        <p><b>ID de Sala:</b> ${res.roomId}</p>
        <p><b>Token Host:</b> ${res.tokenHost}</p>
        <p>Link Jugadores:<br><pre>${window.location.origin + window.location.pathname}?view=play&roomId=${res.roomId}</pre></p>
        <p>Link Host:<br><pre>${window.location.origin + window.location.pathname}?view=host&roomId=${res.roomId}&token=${res.tokenHost}</pre></p>
        <p>Link Pantalla P√∫blica:<br><pre>${window.location.origin + window.location.pathname}?view=screen&roomId=${res.roomId}</pre></p>
      `;
    });
  }

  // === PLAYER ===
  function joinTeam() {
    const teamName = document.getElementById("teamName").value;
    googleApi("apiJoinTeam", [roomId, teamName, ""], res => {
      teamId = res.teamId;
      document.getElementById("join-area").classList.add("hidden");
      document.getElementById("game-area").classList.remove("hidden");
      document.getElementById("result-area").innerHTML = `<p>Equipo unido con ID: ${teamId}</p>`;
    });
  }

  function startGame(mode) {
    googleApi("apiStartPlay", [roomId, teamId, mode, 3], res => {
      playId = res.playId;
      startedAt = res.startedAt;
      renderDoors(res.doorsCount);
    });
  }

  function renderDoors(count) {
    const container = document.getElementById("doors-container");
    container.innerHTML = "";
    for (let i=0; i<count; i++) {
      const d = document.createElement("div");
      d.className = "door";
      d.innerText = i+1;
      d.onclick = () => initialChoice(i);
      container.appendChild(d);
    }
  }

  function initialChoice(choiceIdx) {
    googleApi("apiInitialChoice", [roomId, teamId, playId, choiceIdx], res => {
      googleApi("apiRevealGoats", [roomId, teamId, playId], res2 => {
        revealDoors(res2.revealed, choiceIdx);
        askDecision();
      });
    });
  }

  function revealDoors(revealed, initial) {
    const doors = document.querySelectorAll(".door");
    doors.forEach((d,idx)=>{
      if (revealed.includes(idx)) {
        d.classList.add("goat");
        d.innerText="üêê";
        sndGoat.play();
      }
    });
    doors[initial].style.border="3px solid red";
  }

  function askDecision() {
    const area = document.getElementById("decision-area");
    area.classList.remove("hidden");
    area.innerHTML = `
      <button onclick="finalDecision('keep')">Mantener elecci√≥n</button>
      <button onclick="finalDecision('switch')">Cambiar elecci√≥n</button>
    `;
  }

  function finalDecision(decision) {
    googleApi("apiFinalDecision", [roomId, teamId, playId, decision, startedAt], res => {
      const doors = document.querySelectorAll(".door");
      doors.forEach((d,idx)=>{
        d.classList.add(idx==res.prizeDoor ? "prize":"goat");
        d.innerText = idx==res.prizeDoor ? "üèÜ":"üêê";
      });
      document.getElementById("decision-area").classList.add("hidden");
      document.getElementById("result-area").innerHTML = `<h3>Resultado: ${res.result.toUpperCase()} (Puerta ganadora: ${res.prizeDoor+1})</h3>`;
      if(res.result==="win"){ sndCar.play(); sndWin.play(); }
      else { sndGoat.play(); sndLose.play(); }
    });
  }

  // === HOST ===
  function refreshDashboard() {
    googleApi("apiDashboard", [roomId, token], res => {
      let html = `<h3>${res.room.orgName} - ${res.room.workshopName}</h3>`;
      html += "<h4>Totales:</h4><pre>"+JSON.stringify(res.totals,null,2)+"</pre>";
      html += "<h4>Ranking:</h4><ul>";
      res.teams.forEach(t => {
        html += `<li>${t.teamName} ‚Äî Wins: ${t.wins}, Losses: ${t.losses}, Streak: ${t.streak}</li>`;
      });
      html += "</ul>";
      document.getElementById("host-result").innerHTML = html;
    });
  }

  // === SCREEN ===
  function refreshScreen() {
    googleApi("apiPublicBoard", roomId, res => {
      let html = `<h3>${res.room.orgName} - ${res.room.workshopName}</h3>`;
      html += "<h4>Totales:</h4><pre>"+JSON.stringify(res.totals,null,2)+"</pre>";
      html += "<h4>Ranking:</h4><ul>";
      res.teams.forEach(t => {
        html += `<li>${t.teamName} ‚Äî Wins: ${t.wins}, Losses: ${t.losses}, Streak: ${t.streak}</li>`;
      });
      html += "</ul>";
      document.getElementById("screen-result").innerHTML = html;
    });
  }
</script>
</body>
</html>
