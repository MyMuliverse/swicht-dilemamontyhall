<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dilema Monty Hall</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f1626; color:#fff; text-align:center; }
    .card { background:#1c2541; padding:20px; border-radius:10px; max-width:500px; margin:50px auto; box-shadow:0 0 15px rgba(0,0,0,0.5);}
    input, button { padding:10px; margin:10px; border-radius:5px; border:none; font-size:16px;}
    input { width:80%; }
    button { cursor:pointer; font-weight:bold; }
    .btn-primary { background:#00aaff; color:#fff; }
    .btn-secondary { background:#444; color:#fff; }
    .links { margin-top:20px; text-align:left; }
    .links p { background:#222; padding:8px; border-radius:5px; font-size:14px; }
  </style>
</head>
<body>

  <h1>Dilema Monty Hall</h1>
  <div id="app" class="card"></div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyi16hTRyosSnN6rEq1--3Mg72Dnw67nW5XlP1FpsLXudjgWJBV85RjpMQTV1eGnIs/exec";

  // Detectar rol por URL
  const params = new URLSearchParams(window.location.search);
  const role = params.get("role");
  const code = params.get("code");

  if (!role) {
    // Vista ADMIN
    document.getElementById("app").innerHTML = `
      <h2>M칩dulo Administrador</h2>
      <form id="adminForm">
        <input id="cliente" placeholder="Nombre del cliente" required><br>
        <input id="grupos" type="number" min="1" max="10" placeholder="Cantidad de grupos (1-10)" required><br>
        <button type="submit" class="btn-primary">Generar Partida</button>
      </form>
      <div id="links" class="links"></div>
    `;

    document.getElementById("adminForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const cliente = document.getElementById("cliente").value.trim();
      const grupos = parseInt(document.getElementById("grupos").value);

      const payload = {
        action:"SAVE_GAME",
        CodigoJuego:"J-"+Math.random().toString(36).substring(2,8).toUpperCase(),
        Cliente:cliente,
        Grupo:"ALL",
        FechaCreacion:new Date().toISOString(),
        CodigoInstructor:"I-"+Math.random().toString(36).substring(2,8).toUpperCase(),
        CodigoJugador:"P-"+Math.random().toString(36).substring(2,8).toUpperCase(),
        Estado:"CREATED",
        Ronda:0
      };

      const res = await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
      const data = await res.json();

      if(data.ok){
        const linksDiv = document.getElementById("links");
        linksDiv.innerHTML = `
          <h3>Links generados:</h3>
          <p><b>Instructor:</b> ${window.location.origin}${window.location.pathname}?role=instructor&code=${payload.CodigoInstructor}</p>
          <p><b>Jugador:</b> ${window.location.origin}${window.location.pathname}?role=jugador&code=${payload.CodigoJugador}</p>
        `;
      }else{
        alert("Error: "+data.error);
      }
    });
  }

  if (role==="instructor") {
    // Vista INSTRUCTOR
    document.getElementById("app").innerHTML = `
      <h2>Dashboard Instructor</h2>
      <p>C칩digo: ${code}</p>
      <div id="dash">Cargando...</div>
    `;

    async function loadDash(){
      const res = await fetch(API_URL);
      const data = await res.json();
      if(data.ok){
        let html = "<table border='1' style='width:100%;background:#222;'><tr>";
        Object.keys(data.data[0]).forEach(h=> html+=`<th>${h}</th>`);
        html+="</tr>";
        data.data.forEach(r=>{
          html+="<tr>";
          for(const h in r){ html+=`<td>${r[h]}</td>`; }
          html+="</tr>";
        });
        html+="</table>";
        document.getElementById("dash").innerHTML=html;
      }else{
        document.getElementById("dash").innerText="Error cargando dashboard";
      }
    }
    loadDash();
    setInterval(loadDash,10000); // refresco autom치tico
  }

  if (role==="jugador") {
    // Vista JUGADOR
    document.getElementById("app").innerHTML = `
      <h2>Partida - Jugador</h2>
      <p>C칩digo: ${code}</p>
      <div id="game"></div>
    `;

    // Render simple de 3 puertas
    const gameDiv=document.getElementById("game");
    let ronda=0;

    function renderGame(){
      ronda++;
      gameDiv.innerHTML=`
        <p>Ronda ${ronda}</p>
        <button class="btn-secondary" onclick="choose('stay')">Quedarse</button>
        <button class="btn-primary" onclick="choose('switch')">Cambiar</button>
      `;
    }

    window.choose = async (choice)=>{
      const resultado = Math.random()<0.33 ? "WIN":"LOSE"; // simplificado
      const payload = {
        action:"PLAY",
        CodigoJuego:"J-"+code,
        Cliente:"Anon",
        Grupo:"G1",
        CodigoJugador:code,
        Estado:"PLAYED",
        Observacion:choice,
        Resultado:resultado,
        Ronda:ronda
      };
      await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
      alert(`Resultado: ${resultado}`);
      setTimeout(renderGame,2000);
    }

    renderGame();
  }
  </script>
</body>
</html>
