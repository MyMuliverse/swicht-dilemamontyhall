<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dilema Monty Hall</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#e5e7eb;text-align:center}
    .container{max-width:900px;margin:0 auto;padding:20px}
    .card{background:#1e293b;border-radius:12px;padding:20px;margin:10px}
    .btn{padding:10px 16px;margin:6px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
    .btn-primary{background:#22d3ee;color:#000}
    .btn-secondary{background:#334155;color:#fff}
    input{padding:8px;border-radius:8px;border:1px solid #334155;margin:4px;width:80%}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
    .door{border:3px solid #334155;border-radius:8px;padding:20px;cursor:pointer;background:#0f172a}
    .door.open{background:#1e293b}
    .msg{margin:10px 0;font-size:18px;font-weight:bold}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border:1px solid #334155;padding:6px}
    th{background:#0f172a}
  </style>
</head>
<body>
  <div class="container">
    <h1>Dilema Monty Hall</h1>
    <div id="app"></div>
  </div>

  <!-- sonidos -->
  <audio id="goatSound" src="Goat.wav"></audio>
  <audio id="carSound" src="Car.wav"></audio>
  <audio id="winSound" src="Win.wav"></audio>
  <audio id="loseSound" src="Loses.wav"></audio>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbysZbpNri787On_dbstNIhaYnhBqw3y62sm9qUzsMugtAyWtTpELqOA3F6jk3xQL48/exec";
const ADMIN_PASS = "9090";

let S={role:null,game:null,doors:[],choice:null,opened:null,finished:false};

function el(tag,props={},children=[]){
  const node=document.createElement(tag);
  for(const k in props){
    if(k==="class") node.className=props[k];
    else if(k.startsWith("on")) node[k]=props[k];
    else node.setAttribute(k,props[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(ch=>{
    node.append(ch.nodeType?ch:document.createTextNode(ch));
  });
  return node;
}

function render(){
  const app=document.getElementById("app"); app.innerHTML="";
  if(!S.role) return app.append(viewLogin());
  if(S.role==="admin") return app.append(viewAdmin());
  if(S.role==="instructor") return app.append(viewInstructor());
  if(S.role==="player") return app.append(viewGame());
}

function viewLogin(){
  const c=el("div",{class:"card"});
  c.append(el("h2",{},"Seleccionar rol"));
  const passInput=el("input",{type:"password",placeholder:"Clave"});
  const btnA=el("button",{class:"btn btn-primary",onclick:()=>{
    if(passInput.value===ADMIN_PASS){ S.role="admin"; render(); }
    else alert("Clave inválida");
  }},"Administrador");
  const codeInput=el("input",{placeholder:"Código Instructor/Jugador"});
  const btnI=el("button",{class:"btn btn-secondary",onclick:()=>{S.role="instructor";S.instructorCode=codeInput.value;render();}},"Instructor");
  const btnP=el("button",{class:"btn btn-secondary",onclick:()=>{S.role="player";S.groupCode=codeInput.value;startGame();render();}},"Jugador");
  c.append(passInput,btnA,el("hr"),codeInput,btnI,btnP);
  return c;
}

function viewAdmin(){
  const c=el("div",{class:"card"});
  c.append(el("h2",{},"Módulo Administrador"));
  const inpCliente=el("input",{placeholder:"Cliente"});
  const inpGrupos=el("input",{type:"number",placeholder:"Cantidad de grupos",value:3});
  const btn=el("button",{class:"btn btn-primary",onclick:()=>{
    const n=parseInt(inpGrupos.value)||3;
    const juego="J"+Date.now();
    const codInstructor="I"+Math.random().toString(36).slice(2,8).toUpperCase();
    let grupos=[];
    for(let i=1;i<=n;i++) grupos.push("G"+i+"-"+Math.random().toString(36).slice(2,6).toUpperCase());
    fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
      action:"SAVE_GAME",CodigoJuego:juego,Cliente:inpCliente.value,FechaCreacion:new Date().toISOString(),
      FechaExpira:new Date(Date.now()+30*86400000).toISOString(),CodigoInstructor:codInstructor,Resultado:""
    })});
    c.append(el("div",{class:"msg"},"Links generados:"));
    c.append(el("div",{},"Instructor: "+codInstructor));
    grupos.forEach(g=>{
      const link=location.origin+location.pathname+"?group="+g;
      c.append(el("div",{},["Grupo "+g+" → ",el("a",{href:link,target:"_blank"},link)]));
    });
  }},"Generar Partida");
  c.append(inpCliente,inpGrupos,btn);
  return c;
}

async function viewInstructor(){
  const c=el("div",{class:"card"});
  c.append(el("h2",{},"Vista Instructor"));
  c.append(el("div",{},"Código: "+S.instructorCode));
  try{
    const res=await fetch(API_URL+"?sheet=dashboard");
    const data=await res.json();
    const table=el("table");
    table.append(el("tr",{},[
      el("th",{},"Juego"),el("th",{},"Cliente"),
      el("th",{},"Total"),el("th",{},"Switch"),el("th",{},"Switch ✓"),el("th",{},"Switch ✗"),
      el("th",{},"Stay"),el("th",{},"Stay ✓"),el("th",{},"Stay ✗"),
      el("th",{},"Tasa Switch"),el("th",{},"Tasa Stay")
    ]));
    data.forEach(r=>{
      if(r.CodigoJuego){
        table.append(el("tr",{},[
          el("td",{},r.CodigoJuego), el("td",{},r.Cliente),
          el("td",{},r.TotalJugadas), el("td",{},r.TotalSwitch), el("td",{},r.SwitchGanadas), el("td",{},r.SwitchPerdidas),
          el("td",{},r.TotalStay), el("td",{},r.StayGanadas), el("td",{},r.StayPerdidas),
          el("td",{}, (r.TasaExitoSwitch*100).toFixed(1)+"%"),
          el("td",{}, (r.TasaExitoStay*100).toFixed(1)+"%")
        ]));
      }
    });
    c.append(table);
  }catch(err){
    c.append(el("div",{class:"msg"},"Error cargando dashboard: "+err));
  }
  return c;
}

function startGame(){
  S.doors=["goat","goat","car"];
  S.doors.sort(()=>Math.random()-0.5);
  S.choice=null; S.opened=null; S.finished=false;
}

function viewGame(){
  const c=el("div",{class:"card"});
  c.append(el("h2",{},"Juego Monty Hall"));
  if(S.finished){
    const win=S.doors[S.choice]==="car";
    c.append(el("div",{class:"msg"}, win?"Ganaste el auto! 🚗":"Perdiste, era una cabra 🐐"));
    return c;
  }
  if(S.choice===null){
    c.append(el("p",{},"Elige una puerta:"));
    const grid=el("div",{class:"grid"});
    S.doors.forEach((_,i)=>{
      grid.append(el("div",{class:"door",onclick:()=>{S.choice=i;render();}},"Puerta "+(i+1)));
    });
    c.append(grid);
  }else if(S.opened===null){
    const avail=S.doors.map((d,i)=>(i!==S.choice && d==="goat")?i:null).filter(x=>x!==null);
    S.opened=avail[Math.floor(Math.random()*avail.length)];
    document.getElementById("goatSound").play();
    render();
  }else{
    const grid=el("div",{class:"grid"});
    S.doors.forEach((d,i)=>{
      let text="Puerta "+(i+1);
      if(i===S.opened) text="🐐";
      grid.append(el("div",{class:"door open",onclick:()=>{ if(i!==S.opened) finalize(i); }},text));
    });
    c.append(el("p",{},"¿Te quedás (Stay) o cambiás (Switch)? Hacé click en una puerta."));
    c.append(grid);
  }
  return c;
}

function finalize(newChoice){
  const strategy = (newChoice===S.choice)?"stay":"switch";
  S.choice=newChoice; S.finished=true;
  const win=S.doors[S.choice]==="car";
  if(win){document.getElementById("carSound").play();document.getElementById("winSound").play();}
  else {document.getElementById("goatSound").play();document.getElementById("loseSound").play();}
  fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
    action:"PLAY",CodigoJuego:"",Cliente:"",CodigoInstructor:S.instructorCode||"",CodigoGrupo:S.groupCode||"",
    Resultado: win?"WIN":"LOSE",Observacion:strategy
  })});
  render();
}

render();
</script>
</body>
</html>
