<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Simulador Monty Hall v4.0 Plus</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f6fa;margin:0;padding:24px}
  .wrap{max-width:900px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:24px}
  h1{margin-top:0}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:20px}
  label{display:block;margin:.5rem 0 .25rem;color:#374151}
  input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px}
  button{display:inline-block;padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
  button.secondary{background:#6b7280}
  .doors{display:flex;gap:12px;justify-content:center;margin:16px 0}
  .door{width:100px;height:150px;border-radius:10px;border:3px solid #6b4b2f;background:#d6b894;
        display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;cursor:pointer}
  .door.goat{background:#d1d5db}
  .door.prize{background:#fbbf24}
  .muted{color:#6b7280}
  pre{white-space:pre-wrap;background:#f3f4f6;border-radius:8px;padding:12px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simulador Monty Hall v4.0 Plus</h1>

  <div id="view-admin"   class="card hidden">
    <h2>Admin – Crear sala</h2>
    <label>Organización</label><input id="orgName" placeholder="Universidad Central del Paraguay" />
    <label>Workshop</label><input id="workshopName" placeholder="MBA 2" />
    <button onclick="createRoom()">Crear sala</button>
    <div id="admin-out" class="muted" style="margin-top:10px;"></div>
  </div>

  <div id="view-play"    class="card hidden">
    <h2>Jugador / Equipo</h2>
    <label>Nombre del equipo</label><input id="teamName" placeholder="Equipo Alfa" />
    <button onclick="joinTeam()">Unirse</button>
    <div id="play-out" class="muted" style="margin-top:10px;"></div>
    <div id="game-area" class="hidden">
      <h3>Juego</h3>
      <div>
        <button onclick="startGame('A')">Modo A (3 puertas)</button>
        <button onclick="startGame('B')">Modo B (Monty revela)</button>
      </div>
      <div id="doors" class="doors"></div>
      <div id="decision" class="hidden" style="text-align:center;">
        <button onclick="finalDecision('keep')"  class="secondary">Mantener</button>
        <button onclick="finalDecision('switch')">Cambiar</button>
      </div>
      <div id="result" style="text-align:center;margin-top:8px;"></div>
    </div>
  </div>

  <div id="view-host"    class="card hidden">
    <h2>Instructor / Dashboard</h2>
    <div id="host-out" class="muted"></div>
    <button onclick="refreshDashboard()">Actualizar</button>
  </div>

  <div id="view-screen"  class="card hidden">
    <h2>Pantalla pública</h2>
    <div id="screen-out" class="muted"></div>
    <button onclick="refreshScreen()">Actualizar</button>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <p class="muted">Usa <code>?view=admin</code> para crear sala; luego comparte los links que se generan.</p>
  </div>
</div>

<script>
// ====== CONFIG ======
const API_URL = "https://script.google.com/macros/s/AKfycbyMjhaFOX8w_ftRrMsWZNcZ7noI1L4zPqvftqnHOVR53VC6FFC_FDvDiZLpFLS7Fg/exec";

// ====== JSONP helper ======
function callAPI(params, cb){
  const cbName = "cb_" + Math.random().toString(36).slice(2);
  window[cbName] = (data)=>{ cb(data); delete window[cbName]; script.remove(); };
  const qs = new URLSearchParams({...params, callback:cbName});
  const script = document.createElement("script");
  script.src = API_URL + "?" + qs.toString();
  document.body.appendChild(script);
}

// ====== VIEW ROUTER ======
const Q = new URLSearchParams(location.search);
const VIEW = (Q.get('view')||'admin').toLowerCase();
const roomIdQP = Q.get('roomId')||'';
const tokenQP  = Q.get('token')||'';
['admin','play','host','screen'].forEach(v=>{
  if (v===VIEW) document.getElementById('view-'+v).classList.remove('hidden');
});

// ====== STATE ======
let ROOM_ID = roomIdQP;
let TOKEN   = tokenQP;
let TEAM_ID = null;
let PLAY_ID = null;
let MODE    = 'B';
let STARTED_AT = 0;

// ====== ADMIN ======
function createRoom(){
  const orgName = document.getElementById('orgName').value.trim();
  const workshopName = document.getElementById('workshopName').value.trim();
  callAPI({action:'createRoom', orgName, workshopName}, (d)=>{
    if (d.error) return alert(d.error);
    ROOM_ID = d.roomId; TOKEN = d.tokenHost;
    const base = location.origin + location.pathname;
    const links = `
      <p><b>Room ID:</b> ${ROOM_ID}</p>
      <p><b>Link Jugadores:</b><br><pre>${base}?view=play&roomId=${ROOM_ID}</pre></p>
      <p><b>Link Instructor:</b><br><pre>${base}?view=host&roomId=${ROOM_ID}&token=${TOKEN}</pre></p>
      <p><b>Link Pantalla Pública:</b><br><pre>${base}?view=screen&roomId=${ROOM_ID}</pre></p>
    `;
    document.getElementById('admin-out').innerHTML = links;
  });
}

// ====== PLAYER ======
function joinTeam(){
  const teamName = document.getElementById('teamName').value.trim();
  if (!ROOM_ID){
    const rid = prompt('Pega el Room ID de la sala:');
    if (!rid) return;
    ROOM_ID = rid;
  }
  callAPI({action:'joinTeam', roomId:ROOM_ID, teamName}, (d)=>{
    if (d.error) return alert(d.error);
    TEAM_ID = d.teamId;
    document.getElementById('play-out').innerText = `Equipo unido (ID: ${TEAM_ID}) en sala ${ROOM_ID}`;
    document.getElementById('game-area').classList.remove('hidden');
  });
}

function startGame(mode){
  MODE = mode || 'B';
  callAPI({action:'startPlay', roomId:ROOM_ID, teamId:TEAM_ID, mode:MODE}, (d)=>{
    if (d.error) return alert(d.error);
    PLAY_ID = d.playId; STARTED_AT = d.startedAt || Date.now();
    renderDoors(d.doorsCount||3);
    document.getElementById('result').innerHTML = '';
    document.getElementById('decision').classList.add('hidden');
  });
}

function renderDoors(n){
  const el = document.getElementById('doors'); el.innerHTML = '';
  for (let i=0;i<n;i++){
    const d=document.createElement('div');
    d.className='door';
    d.textContent = (i+1);
    d.onc
