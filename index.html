<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dilema Monty Hall â€“ Simulador</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .container { max-width: 1000px; margin: auto; padding: 20px; }
    .card {
      background: #111827;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .btn {
      background: #22d3ee;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 4px;
    }
    .btn:hover { background: #06b6d4; }
    .door {
      width: 120px; height: 180px;
      background: brown; border: 4px solid #5a3b2e;
      border-radius: 6px;
      display: inline-flex; align-items: center; justify-content: center;
      margin: 10px; color: #fff; font-weight: bold; cursor: pointer;
      transition: transform .5s;
    }
    .door.open { transform: rotateY(160deg); background: #333; }
    .toast {
      position: fixed; bottom: 20px; right: 20px;
      background: #22c55e; color: #fff; padding: 10px 20px;
      border-radius: 8px; opacity: 0; transition: opacity .5s;
    }
    .toast.show { opacity: 1; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="app"></div>
  </div>
  <div id="toast" class="toast"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwWuYxxl4-PcGvlNPXF1J3al2Ch2OAbq6m369jcTeHQ6tbZjflyMhLR62G1aYZlPkA/exec";

// ðŸŽ§ sonidos
function playSound(name) {
  const audio = new Audio(`assets/sounds/${name}.mp3`);
  audio.play();
}

// ðŸ”” toast
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

// rol segun query
const params = new URLSearchParams(location.search);
const role = params.get("role") || "player";
const token = params.get("t") || "";

function render() {
  if (role === "admin") return renderAdmin();
  if (role === "instructor") return renderInstructor();
  return renderPlayer();
}

// ===== ADMIN =====
function renderAdmin() {
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Administrador</h2>
      <input id="cliente" placeholder="Cliente" class="input"/>
      <button class="btn" onclick="crearPartida()">Crear partida</button>
      <div id="links"></div>
    </div>
  `;
}
async function crearPartida() {
  const cliente = document.getElementById("cliente").value || "Cliente";
  const codigoJuego = "J-" + Math.random().toString(36).substring(2,8).toUpperCase();
  const codigoInstructor = "I-" + Math.random().toString(36).substring(2,8).toUpperCase();
  const fecha = new Date().toISOString().split("T")[0];
  const expira = new Date(Date.now() + 30*24*60*60*1000).toISOString().split("T")[0];
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "save_game",
      CodigoJuego: codigoJuego,
      Cliente: cliente,
      FechaCreacion: fecha,
      FechaExpira: expira,
      CodigoInstructor: codigoInstructor,
      Resultado: ""
    })
  });
  const urlJugador = location.origin + location.pathname + "?t=" + codigoJuego;
  const urlInstructor = location.origin + location.pathname + "?role=instructor&t=" + codigoJuego + "&ci=" + codigoInstructor;
  document.getElementById("links").innerHTML = `
    <p><b>Link Jugadores:</b> <a href="${urlJugador}" target="_blank">${urlJugador}</a></p>
    <p><b>Link Instructor:</b> <a href="${urlInstructor}" target="_blank">${urlInstructor}</a></p>
  `;
  showToast("Partida creada y guardada");
}

// ===== INSTRUCTOR =====
let autoRefresh = null;
function renderInstructor() {
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Instructor â€“ Dashboard</h2>
      <button class="btn" onclick="cargarDatos()">Cargar</button>
      <button class="btn" onclick="toggleAuto()">Auto-refresh</button>
      <button class="btn" onclick="exportCSV()">Exportar CSV</button>
      <button class="btn" onclick="exportPDF()">Exportar PDF</button>
      <div id="stats"></div>
    </div>
  `;
}
async function cargarDatos() {
  const res = await fetch(API_URL + "?sheet=links");
  const data = await res.json();
  const rows = data.filter(r => r.CodigoJuego === token);
  const gananCambio = rows.filter(r => r.Accion === "PLAY" && r.Resultado === "GANA_CAMBIO").length;
  const gananSin = rows.filter(r => r.Accion === "PLAY" && r.Resultado === "GANA_SIN_CAMBIO").length;
  const pierden = rows.filter(r => r.Accion === "PLAY" && r.Resultado.startsWith("PIERDE")).length;
  document.getElementById("stats").innerHTML = `
    <p>Ganaron cambiando: ${gananCambio}</p>
    <p>Ganaron sin cambiar: ${gananSin}</p>
    <p>Perdieron: ${pierden}</p>
  `;
}
function toggleAuto() {
  if (autoRefresh) {
    clearInterval(autoRefresh); autoRefresh = null;
    showToast("Auto-refresh apagado");
  } else {
    autoRefresh = setInterval(cargarDatos, 10000);
    showToast("Auto-refresh encendido");
  }
}
function exportCSV() {
  fetch(API_URL + "?sheet=links").then(r=>r.json()).then(data=>{
    const rows = data.filter(r => r.CodigoJuego === token);
    const csv = "data:text/csv;charset=utf-8," + rows.map(r => Object.values(r).join(",")).join("\n");
    const a = document.createElement("a");
    a.href = encodeURI(csv); a.download = "resultados.csv"; a.click();
  });
}
function exportPDF() {
  fetch(API_URL + "?sheet=links").then(r=>r.json()).then(data=>{
    const rows = data.filter(r => r.CodigoJuego === token);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Resultados Monty Hall", 10, 10);
    rows.forEach((r,i)=> doc.text(`${i+1}. ${r.Rol} ${r.Resultado}`, 10, 20+i*10));
    doc.save("resultados.pdf");
  });
}

// ===== JUGADOR =====
function renderPlayer() {
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Jugador â€“ Dilema Monty Hall</h2>
      <p>Elige una puerta</p>
      <div id="doors"></div>
    </div>
  `;
  const doorsDiv = document.getElementById("doors");
  const car = Math.floor(Math.random()*3);
  for(let i=0;i<3;i++) {
    const d = document.createElement("div");
    d.className="door"; d.textContent="Puerta "+(i+1);
    d.onclick=()=>selectDoor(i,car,d);
    doorsDiv.appendChild(d);
  }
}
function selectDoor(choice, car, elem) {
  elem.classList.add("open");
  setTimeout(()=>{
    const reveal = [0,1,2].find(x => x!==choice && x!==car);
    document.querySelectorAll(".door")[reveal].classList.add("open");
    playSound("goat");
    setTimeout(()=>{
      if(confirm("Â¿Quieres cambiar de puerta?")) {
        choice = [0,1,2].find(x => x!==choice && x!==reveal);
      }
      const win = (choice===car);
      if(win){ playSound("win"); showToast("Â¡Ganaste el auto!"); }
      else { playSound("lose"); showToast("CayÃ³ cabra"); }
      fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"play",
          CodigoJuego:token,
          Cliente:"Anon",
          CodigoInstructor:"",
          CodigoJugador:"P-"+Math.random().toString(36).substr(2,5),
          Resultado: win ? (choice===car?"GANA_CAMBIO":"GANA_SIN_CAMBIO") : "PIERDE"
        })
      });
    },1500);
  },1000);
}

render();
</script>
</body>
</html>
