<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador - Admin & Jugadores</title>
<style>
  :root{--blue:#1f6feb;--bg:#f5f6f8;--card:#ffffff;--muted:#666}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:24px auto;padding:18px}
  .card{background:var(--card);border-radius:10px;padding:18px;margin-bottom:16px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}
  button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.ghost{background:#eee;color:#222}
  .small{font-size:13px;color:var(--muted)}
  .links-list{margin-top:8px}
  .link-item{background:#fbfbff;padding:10px;border-radius:8px;border:1px solid #eee;margin:8px 0;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .codes{font-family:monospace;background:#f1f5ff;padding:8px;border-radius:6px}
  .doors{display:flex;gap:12px;justify-content:center;margin:18px 0}
  .door{width:120px;height:180px;background:#1f2a44;color:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer}
  .result{margin-top:12px;font-weight:bold}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Simulador Dilema Monty Hall ‚Äî Administrador</h1>
      <p class="small">Ingres√° tu clave maestra para acceder al panel de administrador.</p>
      <div class="row">
        <input id="masterKey" placeholder="Clave maestra" />
        <button onclick="adminLogin()">Entrar</button>
        <button class="ghost" onclick="showPublic()">Entrar como Cliente/Invitado</button>
      </div>
      <p class="small">Clave maestra por defecto: <strong>9090</strong> (puedes cambiarla en el c√≥digo)</p>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="card" style="display:none">
      <h2>Panel de Administrador</h2>
      <div class="row" style="margin-bottom:10px;">
        <input id="clientName" placeholder="Nombre del cliente / empresa" />
        <input id="qtyPlayers" type="number" min="1" max="200" value="5" style="width:110px" />
        <label class="small">C√≥digos participantes</label>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <label class="small">Duraci√≥n (d√≠as)</label>
        <input id="daysValid" type="number" min="1" value="30" style="width:90px" />
        <button onclick="createGame()">Generar nueva partida</button>
      </div>

      <div class="small muted">Al generar obtendr√°s: link (para enviar), c√≥digo instructor, c√≥digos de participantes. Link y c√≥digos quedan v√°lidos por X d√≠as y cada c√≥digo participante se bloquea al usarse.</div>

      <div style="margin-top:18px">
        <h3>Partidas generadas</h3>
        <div id="gamesList" class="links-list"></div>
      </div>

      <div style="margin-top:18px">
        <button onclick="exportAll()">Exportar todas las partidas (JSON)</button>
        <button class="ghost" onclick="clearAllLocal()">Borrar datos locales (solo localStorage)</button>
      </div>
    </div>

    <!-- PUBLIC / PLAYER ENTRY -->
    <div id="playerPanel" class="card" style="display:none">
      <h2>Acceso a partida</h2>
      <div id="playerIntro" class="small muted">Ingres√° el c√≥digo que te dio el instructor o abr√≠ el link que recibiste.</div>
      <div style="margin-top:12px">
        <input id="playerCode" placeholder="C√≥digo participante" />
        <button onclick="loginPlayer()">Entrar</button>
      </div>

      <div id="gameArea" style="display:none;margin-top:14px">
        <h3 id="gameTitle"></h3>
        <div class="doors" id="doorsWrap"></div>
        <div class="row" style="justify-content:center">
          <button onclick="simulate(true)">Simular con cambio</button>
          <button class="ghost" onclick="simulate(false)">Simular sin cambio</button>
        </div>
        <div id="playResult" class="result"></div>
      </div>
    </div>

    <div id="infoBox" class="card" style="display:none">
      <h3>Informaci√≥n</h3>
      <div id="infoText" class="small"></div>
    </div>
  </div>

<script>
/*
  Reglas / almacenamiento
  - intentamos persistir en API_URL si est√° configurado (tu Apps Script). Si no, usamos localStorage.
  - Estructura localStorage key "mh_games" => objeto { gameCode: {...} }
  - game object:
    {
      gameCode: "ABC123",
      clientName: "Acme",
      createdAt: timestamp,
      expiresAt: timestamp,
      instructorCode: "INST1",
      playerCodes: { "P1": {used:false, usedAt:null}, ... },
      usedCount: 0
    }
*/

const MASTER_KEY = "9090"; // tu clave maestra (cambiarla aqu√≠ si quer√©s)
const API_URL = ""; // si ten√©s Apps Script para persistir, pon ac√° tu endpoint (opcional), ejemplo la URL del script
const STORAGE_KEY = "mh_games_v1";

/* ---------- UTIL ---------- */
function randCode(len=6){
  const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s="";
  for(let i=0;i<len;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
  return s;
}
function nowTs(){ return Date.now(); }
function daysFromNow(days){ return Date.now()+days*24*3600*1000; }

/* ---------- STORAGE: local + optional remote ---------- */
function loadGamesLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : {};
}
function saveGamesLocal(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}
async function tryRemoteSave(payload){
  if(!API_URL) return {ok:false, msg:"no api url"};
  try{
    const r = await fetch(API_URL, {
      method:"POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    return {ok:true, res:j};
  }catch(e){
    return {ok:false, msg:e.message};
  }
}

/* ---------- ADMIN UI ---------- */
function adminLogin(){
  const key = document.getElementById("masterKey").value.trim();
  if(key===MASTER_KEY){
    document.getElementById("adminPanel").style.display="block";
    document.getElementById("playerPanel").style.display="none";
    refreshGamesList();
    showInfo("Acceso administrativo concedido", true);
  } else {
    alert("Clave incorrecta");
  }
}
function showPublic(){
  document.getElementById("adminPanel").style.display="none";
  document.getElementById("playerPanel").style.display="block";
  // if link contains game param, pre-fill
  const params = new URLSearchParams(window.location.search);
  if(params.has("game")){
    const code = params.get("game");
    // prefill code field
    document.getElementById("playerCode").value = code;
  }
}

/* ---------- CREATE GAME ---------- */
async function createGame(){
  const clientName = (document.getElementById("clientName").value || "").trim();
  const qty = Math.max(1, parseInt(document.getElementById("qtyPlayers").value || 5));
  const days = Math.max(1, parseInt(document.getElementById("daysValid").value || 30));
  if(!clientName) return alert("Ingres√° nombre del cliente");

  const gameCode = randCode(6);
  const instructorCode = randCode(6);
  const playerCodes = {};
  for(let i=0;i<qty;i++) playerCodes[randCode(6)] = {used:false, usedAt:null};

  const g = {
    gameCode,
    clientName,
    createdAt: nowTs(),
    expiresAt: daysFromNow(days),
    instructorCode,
    playerCodes,
    usedCount:0
  };

  // save local
  const all = loadGamesLocal();
  all[gameCode]=g;
  saveGamesLocal(all);

  // try remote save (async) so Sheets can also store if lo configuraste
  tryRemoteSave({action:"save_game",game:g}).then(r=>{ if(!r.ok) console.log("remote save failed", r); });

  refreshGamesList();
  showInfo("Partida creada. Copiala y mandala al cliente (link y c√≥digos).", true);
}

/* ---------- UI: list games ---------- */
function refreshGamesList(){
  const cont = document.getElementById("gamesList");
  cont.innerHTML="";
  const all = loadGamesLocal();
  const keys = Object.keys(all).sort((a,b)=>all[b].createdAt-all[a].createdAt);
  if(keys.length===0){
    cont.innerHTML = "<div class='small muted'>No hay partidas generadas.</div>";
    return;
  }
  keys.forEach(k=>{
    const g = all[k];
    const item = document.createElement("div");
    item.className="link-item";
    const left = document.createElement("div");
    left.innerHTML = `<strong>${g.clientName}</strong><div class="small muted">C√≥digo: ${g.gameCode} ¬∑ Expira: ${new Date(g.expiresAt).toLocaleString()}</div>`;
    const right = document.createElement("div");
    // link
    const link = `${window.location.origin}${window.location.pathname}?game=${g.gameCode}`;
    const btnCopyLink = document.createElement("button");
    btnCopyLink.textContent="Copiar link";
    btnCopyLink.onclick = ()=>{navigator.clipboard.writeText(link); alert("Link copiado");};

    const btnCopyCodes = document.createElement("button");
    btnCopyCodes.textContent="Copiar c√≥digos";
    btnCopyCodes.onclick = ()=>{
      // prepare text
      const codes = Object.keys(g.playerCodes).map(c=> `${c} ${g.playerCodes[c].used ? "(usado)" : ""}`).join("\n");
      const txt = `Link: ${link}\nInstructor: ${g.instructorCode}\nC√≥digos participantes:\n${codes}`;
      navigator.clipboard.writeText(txt);
      alert("C√≥digos copiados al portapapeles");
    };

    const btnInvalidate = document.createElement("button");
    btnInvalidate.className="ghost";
    btnInvalidate.textContent="Caducar ahora";
    btnInvalidate.onclick = ()=>{
      if(!confirm("Forzar expiraci√≥n ahora?")) return;
      g.expiresAt = Date.now()-1000;
      const all2 = loadGamesLocal(); all2[g.gameCode]=g; saveGamesLocal(all2); refreshGamesList();
    };

    right.appendChild(btnCopyLink);
    right.appendChild(document.createTextNode(" "));
    right.appendChild(btnCopyCodes);
    right.appendChild(document.createTextNode(" "));
    right.appendChild(btnInvalidate);

    item.appendChild(left);
    item.appendChild(right);
    cont.appendChild(item);
  });
}

/* ---------- PLAYER FLOW ---------- */
function loginPlayer(){
  const code = (document.getElementById("playerCode").value || "").trim();
  if(!code) return alert("Ingres√° un c√≥digo participante");
  // find which game contains this participant code or if code equals instructor code
  const all = loadGamesLocal();
  let foundGame = null, role = "participant", playerKey = null;
  for(const k in all){
    const g = all[k];
    if(g.instructorCode === code){ foundGame = g; role="instructor"; break; }
    if(g.playerCodes && g.playerCodes[code]!==undefined){ foundGame=g; role="participant"; playerKey=code; break; }
  }
  if(!foundGame) return alert("C√≥digo no v√°lido o no encontrado");
  // check expiration
  if(Date.now() > foundGame.expiresAt) return alert("Este link/c√≥digo expir√≥");

  // if participant check used
  if(role==="participant" && foundGame.playerCodes[playerKey].used) return alert("Este c√≥digo ya fue utilizado");

  // mark used if participant
  if(role==="participant"){
    foundGame.playerCodes[playerKey].used = true;
    foundGame.playerCodes[playerKey].usedAt = Date.now();
    foundGame.usedCount = (foundGame.usedCount||0) + 1;
    const all2 = loadGamesLocal(); all2[foundGame.gameCode]=foundGame; saveGamesLocal(all2);
    tryRemoteSave({action:"mark_used",gameCode:foundGame.gameCode,playerCode:playerKey});
  }

  // show game UI
  startGame(foundGame, role);
}

/* ---------- GAME UI & SIMULATION ---------- */
let CURRENT_GAME = null;
let CHOSEN_DOOR = null;
function startGame(game, role){
  CURRENT_GAME = game;
  CHOSEN_DOOR = null;
  document.getElementById("playerPanel").style.display="block";
  document.getElementById("gameArea").style.display="block";
  document.getElementById("gameTitle").innerText = `Partida: ${game.clientName} (${role})`;
  // render doors
  const wrap = document.getElementById("doorsWrap");
  wrap.innerHTML="";
  for(let i=1;i<=3;i++){
    const d = document.createElement("div");
    d.className="door";
    d.innerText=i;
    d.onclick = ()=>{ CHOSEN_DOOR=i; document.getElementById("playResult").innerText=`Elegiste la puerta ${i}`; };
    wrap.appendChild(d);
  }
  showInfo(`Entraste a la partida "${game.clientName}". C√≥digo de instructor: ${game.instructorCode}`, true);
}

function simulate(change){
  if(!CURRENT_GAME) return alert("No hay partida activa");
  if(!CHOSEN_DOOR) return alert("Eleg√≠ una puerta primero");
  const prize = Math.floor(Math.random()*3)+1;
  // Monty opens a non-prize non-chosen door (not shown UI, but we compute final)
  let finalChoice;
  if(change){
    // change: choose a door different from chosen and Monty's opened (simulate by selecting the other not chosen)
    const options = [1,2,3].filter(x=>x!==CHOSEN_DOOR);
    finalChoice = options[Math.floor(Math.random()*options.length)];
  } else {
    finalChoice = CHOSEN_DOOR;
  }
  const win = finalChoice===prize;
  document.getElementById("playResult").innerText = win ? "üéâ ¬°Ganaste!" : `‚ùå Perdiste. El premio estaba en la puerta ${prize}`;
  // optionally persist result
  tryRemoteSave({action:"play",gameCode:CURRENT_GAME.gameCode,result:{win,prize,choice:CHOSEN_DOOR,finalChoice,ts:Date.now()}});
}

/* ---------- HELPERS ---------- */
function showInfo(msg, showCard=false){
  const box = document.getElementById("infoBox");
  const txt = document.getElementById("infoText");
  txt.innerText = msg;
  box.style.display = showCard ? "block" : "none";
}

/* ---------- EXPORT / CLEAR ---------- */
function exportAll(){
  const all = loadGamesLocal();
  const data = JSON.stringify(all, null, 2);
  // download
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "mh_games_export.json"; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500);
}
function clearAllLocal(){
  if(!confirm("Borrar todos los datos guardados en este navegador? Esto NO afecta a tu API si la est√°s usando.")) return;
  localStorage.removeItem(STORAGE_KEY);
  refreshGamesList();
  alert("Datos locales eliminados");
}

/* ---------- AUTO: si abr√≠s con ?game=xxxx pre-carga y muestra panel jugador ---------- */
(function initFromUrl(){
  const params = new URLSearchParams(window.location.search);
  if(params.has("game")){
    const code = params.get("game");
    // if we have a game with that code show player panel and prefill
    const all = loadGamesLocal();
    if(all[code]){
      document.getElementById("playerPanel").style.display="block";
      document.getElementById("playerCode").value = code;
    } else {
      // still show playerPanel so user can paste code
      document.getElementById("playerPanel").style.display="block";
      document.getElementById("playerCode").value = code;
    }
  }
})();
</script>
</body>
</html>
