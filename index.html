<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dilema Monty Hall</title>
<style>
  :root{--blue:#1f6feb;--bg:#f5f6f8;--card:#ffffff;--muted:#666}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:24px auto;padding:18px}
  .card{background:var(--card);border-radius:10px;padding:18px;margin-bottom:16px;box-shadow:0 4px 18px rgba(0,0,0,.06)}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px}
  button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.ghost{background:#eee;color:#222}
  .small{font-size:13px;color:var(--muted)}
  .links-list{margin-top:8px}
  .link-item{background:#fbfbff;padding:10px;border-radius:8px;border:1px solid #eee;margin:8px 0;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .doors{display:flex;gap:12px;justify-content:center;margin:18px 0}
  .door{width:120px;height:180px;background:#1f2a44;color:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer}
  .result{margin-top:12px;font-weight:bold}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Simulador Dilema Monty Hall ‚Äî Administrador</h1>
      <p class="small">Ingres√° tu clave maestra para acceder al panel de administrador.</p>
      <div class="row">
        <input id="masterKey" placeholder="Clave maestra" />
        <button onclick="adminLogin()">Entrar</button>
        <button class="ghost" onclick="showPublic()">Entrar como Cliente/Invitado</button>
      </div>
      <p class="small">Clave maestra por defecto: <strong>9090</strong></p>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="card" style="display:none">
      <h2>Panel de Administrador</h2>
      <div class="row" style="margin-bottom:10px;">
        <input id="clientName" placeholder="Nombre del cliente / empresa" />
        <input id="qtyPlayers" type="number" min="1" max="200" value="5" style="width:110px" />
        <label class="small">C√≥digos participantes</label>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <label class="small">Duraci√≥n (d√≠as)</label>
        <input id="daysValid" type="number" min="1" value="30" style="width:90px" />
        <button onclick="createGame()">Generar nueva partida</button>
      </div>

      <div style="margin-top:18px">
        <h3>Partidas generadas</h3>
        <div id="gamesList" class="links-list"></div>
      </div>
    </div>

    <!-- PUBLIC / PLAYER ENTRY -->
    <div id="playerPanel" class="card" style="display:none">
      <h2>Acceso a partida</h2>
      <div id="playerIntro" class="small muted">Ingres√° el c√≥digo que te dio el instructor o abr√≠ el link que recibiste.</div>
      <div style="margin-top:12px">
        <input id="playerCode" placeholder="C√≥digo participante" />
        <button onclick="loginPlayer()">Entrar</button>
      </div>

      <div id="gameArea" style="display:none;margin-top:14px">
        <h3 id="gameTitle"></h3>
        <div class="doors" id="doorsWrap"></div>
        <div class="row" style="justify-content:center">
          <button onclick="simulate(true)">Simular con cambio</button>
          <button class="ghost" onclick="simulate(false)">Simular sin cambio</button>
        </div>
        <div id="playResult" class="result"></div>
      </div>
    </div>

  </div>

<script>
const MASTER_KEY = "9090";
const API_URL = "https://script.google.com/macros/s/AKfycbxFiB-ADDPpiZsXBU0nGjFtS2In7IqvFewrJEZdJueQjsz5LyvVNvgMnR4a_uRfOY4/exec";
const STORAGE_KEY = "mh_games_v1";

/* --- UTIL --- */
function randCode(len=6){
  const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s="";
  for(let i=0;i<len;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
  return s;
}
function nowIso(){ return new Date().toISOString(); }
function daysFromNow(days){ return new Date(Date.now()+days*24*3600*1000).toISOString(); }

/* --- STORAGE LOCAL --- */
function loadGamesLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : {};
}
function saveGamesLocal(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

/* --- REMOTE SAVE --- */
async function saveToSheet(payload){
  try {
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch(err){
    console.error("Error guardando en sheet:", err);
    return {ok:false, error:err.message};
  }
}

/* --- ADMIN --- */
function adminLogin(){
  const key = document.getElementById("masterKey").value.trim();
  if(key===MASTER_KEY){
    document.getElementById("adminPanel").style.display="block";
    document.getElementById("playerPanel").style.display="none";
    refreshGamesList();
  } else {
    alert("Clave incorrecta");
  }
}
function showPublic(){
  document.getElementById("adminPanel").style.display="none";
  document.getElementById("playerPanel").style.display="block";
}

/* --- CREATE GAME --- */
async function createGame(){
  const clientName = (document.getElementById("clientName").value||"").trim();
  const qty = parseInt(document.getElementById("qtyPlayers").value||5);
  const days = parseInt(document.getElementById("daysValid").value||30);
  if(!clientName) return alert("Ingres√° nombre del cliente");

  const gameCode = randCode(6);
  const instructorCode = randCode(6);
  const playerCodes = {};
  for(let i=0;i<qty;i++) playerCodes[randCode(6)] = {used:false};

  const g = {
    gameCode, clientName,
    createdAt: nowIso(),
    expiresAt: daysFromNow(days),
    instructorCode, playerCodes
  };

  // local
  const all = loadGamesLocal(); all[gameCode]=g; saveGamesLocal(all);

  // remoto
  await saveToSheet({
    action:"save_game",
    FechaRegistro: nowIso(),
    Accion: "SAVE_GAME",
    CodigoJuego: gameCode,
    Cliente: clientName,
    FechaCreacion: g.createdAt,
    FechaExpira: g.expiresAt,
    CodigoInstructor: instructorCode,
    Resultado: JSON.stringify(playerCodes)
  });

  refreshGamesList();
  alert("Partida creada y guardada en la hoja.");
}

/* --- LIST GAMES --- */
function refreshGamesList(){
  const cont=document.getElementById("gamesList");
  cont.innerHTML="";
  const all = loadGamesLocal();
  Object.values(all).forEach(g=>{
    const link = `${window.location.origin}${window.location.pathname}?game=${g.gameCode}`;
    const div=document.createElement("div");
    div.className="link-item";
    div.innerHTML = `<div><strong>${g.clientName}</strong><br>
    <span class="small muted">Juego: ${g.gameCode} ¬∑ Expira: ${g.expiresAt}</span></div>`;
    const b1=document.createElement("button");
    b1.textContent="Copiar link";
    b1.onclick=()=>{navigator.clipboard.writeText(link); alert("Link copiado");};
    div.appendChild(b1);
    cont.appendChild(div);
  });
}

/* --- PLAYER FLOW --- */
async function loginPlayer(){
  const code = (document.getElementById("playerCode").value||"").trim();
  if(!code) return alert("Ingres√° un c√≥digo");

  const all=loadGamesLocal();
  let found=null, role="participant";
  for(const g of Object.values(all)){
    if(g.instructorCode===code){found=g; role="instructor"; break;}
    if(g.playerCodes[code]!==undefined){found=g; role="participant"; break;}
  }
  if(!found) return alert("C√≥digo no v√°lido");

  if(role==="participant" && found.playerCodes[code].used) return alert("C√≥digo ya usado");

  if(role==="participant"){
    found.playerCodes[code].used=true;
    saveGamesLocal(all);
    await saveToSheet({
      action:"mark_used",
      FechaRegistro: nowIso(),
      Accion: "USED",
      CodigoJuego: found.gameCode,
      Cliente: found.clientName,
      CodigoInstructor: found.instructorCode,
      CodigoJugador: code,
      Estado: "usado"
    });
  }

  startGame(found, role);
}

/* --- GAME --- */
let CURRENT=null, CHOICE=null;
function startGame(g,role){
  CURRENT=g; CHOICE=null;
  document.getElementById("gameArea").style.display="block";
  document.getElementById("gameTitle").innerText=`Partida ${g.clientName} (${role})`;
  const wrap=document.getElementById("doorsWrap"); wrap.innerHTML="";
  for(let i=1;i<=3;i++){
    const d=document.createElement("div");
    d.className="door"; d.textContent=i;
    d.onclick=()=>{CHOICE=i; document.getElementById("playResult").innerText=`Elegiste la puerta ${i}`;};
    wrap.appendChild(d);
  }
}

async function simulate(change){
  if(!CURRENT) return;
  if(!CHOICE) return alert("Eleg√≠ una puerta");
  const prize=Math.floor(Math.random()*3)+1;
  let finalChoice;
  if(change){
    const opts=[1,2,3].filter(x=>x!==CHOICE);
    finalChoice=opts[Math.floor(Math.random()*opts.length)];
  } else finalChoice=CHOICE;
  const win=finalChoice===prize;
  document.getElementById("playResult").innerText=win?"üéâ ¬°Ganaste!":"‚ùå Perdiste. El premio estaba en "+prize;

  await saveToSheet({
    action:"play",
    FechaRegistro: nowIso(),
    Accion:"PLAY",
    CodigoJuego: CURRENT.gameCode,
    Cliente: CURRENT.clientName,
    CodigoInstructor: CURRENT.instructorCode,
    Resultado: JSON.stringify({win,prize,choice:CHOICE,finalChoice})
  });
}
</script>
</body>
</html>
