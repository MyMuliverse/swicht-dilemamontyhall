<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Dilema Monty Hall</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f172a; --card:#1e293b; --muted:#94a3b8; --line:#334155;
    --brand:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .center{text-align:center}
  .card{background:var(--card);border:1px solid #203042;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid;gap:16px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);color:#042027}
  .secondary{background:#334155;color:#e5e7eb}
  .danger{background:var(--bad);color:#fff}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#e5e7eb}
  .muted{color:var(--muted)}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .kpi{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:14px}
  .kpi h4{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .kpi .v{font-size:24px;font-weight:800}
  .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
  .copyrow{display:flex;gap:8px;align-items:center}
  .copyrow input{flex:1}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--line);padding:10px 14px;border-radius:10px;opacity:0;transition:.2s}
  .toast.show{opacity:1}
  .spinner{width:18px;height:18px;border:2px solid #3b4b63;border-top-color:#9bd3ff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Puertas */
  .doors{display:flex;justify-content:center;gap:18px;margin-top:8px}
  .door{
    width:100px;height:160px;background:#0b1220;border:3px solid var(--line);border-radius:10px;
    display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;cursor:pointer;transition:.15s
  }
  .door:hover{transform:translateY(-2px)}
  .door.disabled{opacity:.5;filter:grayscale(.6);cursor:not-allowed}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="center">Dilema Monty Hall</h1>
  <div id="app" class="grid"></div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Copiado</div>

<!-- Sonidos (coloca estos archivos en la ra√≠z del repo) -->
<audio id="sGoat" src="./Goat.wav" preload="auto"></audio>
<audio id="sCar"  src="./Car.wav"  preload="auto"></audio>
<audio id="sWin"  src="./Win.wav"  preload="auto"></audio>
<audio id="sLose" src="./Loses.wav" preload="auto"></audio>

<script>
/* ===== CONFIG ===== */
const ADMIN_KEY  = "9090";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysZbpNri787On_dbstNIhaYnhBqw3y62sm9qUzsMugtAyWtTpELqOA3F6jk3xQL48/exec";
const BASE_URL   = location.origin + location.pathname.replace(/index\.html?$/i,"");

/* ===== STATE ===== */
const ST = {
  role: null,
  admin: {},
  instructor: { code:null, game:null, timer:null, chart:null },
  player: { game:null, group:null, choice:null, open:null, prize:null, finished:false }
};

/* ===== UTILS ===== */
const $ = s => document.querySelector(s);
function el(tag, props={}, children){
  const n=document.createElement(tag);
  for(const k in props){
    if(k==="class") n.className=props[k];
    else if(k.startsWith("on")) n[k]=props[k];
    else n.setAttribute(k, props[k]);
  }
  if(children!==undefined){
    (Array.isArray(children)?children:[children]).forEach(ch=>n.append(ch?.nodeType?ch:document.createTextNode(ch)));
  }
  return n;
}
function rid(len=6){return Array.from(crypto.getRandomValues(new Uint8Array(len))).map(b=>"abcdefghijklmnopqrstuvwxyz0123456789"[b%36]).join('');}
function copy(t){navigator.clipboard.writeText(t).then(()=>toast("Copiado"));}
function toast(msg){const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400);}
function q(k){return new URLSearchParams(location.search).get(k)}

/* ===== RENDER ROOT ===== */
function mount(node){ const app=$("#app"); app.innerHTML=""; app.append(node); }

/* ===== ADMIN ===== */
function viewAdminLogin(){
  return el('div',{class:'card'},[
    el('h3',{},'Acceso Administrador'),
    el('p',{class:'muted'},'Ingres√° tu clave √∫nica para generar los links.'),
    el('input',{id:'admPass',type:'password',placeholder:'Clave administrador'}),
    el('button',{class:'btn primary',onclick:()=>{
      if($("#admPass").value===ADMIN_KEY) mount(viewAdminPanel());
      else alert("Clave incorrecta");
    }},'Entrar')
  ]);
}

function viewAdminPanel(){
  const box = el('div',{class:'card'});
  box.append(
    el('h3',{},'Panel Administrador'),
    el('div',{class:'muted'},'Gener√° un juego, obten√© 1 link de Instructor y N links de Grupo.'),
    el('div',{class:'hr'}),
    el('div',{class:'grid g2'},[
      el('div',{class:'card'},[
        el('label',{},'Cliente'),
        el('input',{id:'admCliente',placeholder:'Empresa / Curso'}),
        el('label',{},'D√≠as de validez'),
        el('input',{id:'admDays',type:'number',value:'30',min:'1'}),
        el('label',{},'Cantidad de grupos (1‚Äì10)'),
        el('input',{id:'admGroups',type:'number',value:'3',min:'1',max:'10'}),
        el('button',{class:'btn primary',onclick:createGame},'Crear juego')
      ]),
      el('div',{class:'card',id:'admOut'},[
        el('div',{class:'muted'},'A√∫n no generaste nada.')
      ])
    ])
  );
  return box;
}

async function createGame(){
  const cliente = $("#admCliente").value.trim();
  const days = Math.max(1, +$("#admDays").value||30);
  const n = Math.max(1, Math.min(10, +$("#admGroups").value||1));
  if(!cliente) return toast("Ingres√° un cliente");

  const CodigoJuego = "GAME-" + rid(6).toUpperCase();
  const CodigoInstructor = "INST-" + rid(8).toUpperCase();
  const created = new Date();
  const exp = new Date(created.getTime()+days*86400000);

  // Guardamos el juego (SAVE_GAME)
  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({
      action:"SAVE_GAME",
      CodigoJuego, Cliente:cliente,
      FechaCreacion: created.toISOString(),
      FechaExpira: exp.toISOString(),
      CodigoInstructor: CodigoInstructor,
      Resultado:""
    })
  });

  // Generamos grupos
  const groups=[];
  for(let i=1;i<=n;i++){
    const CodigoGrupo = "GRP-" + rid(6).toUpperCase();
    groups.push({i,CodigoGrupo});
    // Opcional: registrar cada grupo como SAVE_GAME para dejar huella
    fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({
      action:"SAVE_GAME",
      CodigoJuego, Cliente:cliente,
      FechaCreacion: created.toISOString(),
      FechaExpira: exp.toISOString(),
      CodigoInstructor: CodigoInstructor,
      CodigoGrupo,
      Resultado:`CREATED(G${i})`
    })});
  }

  // Construimos links
  const linkInstructor = `${BASE_URL}?role=instructor&code=${encodeURIComponent(CodigoInstructor)}&game=${encodeURIComponent(CodigoJuego)}`;
  let html = `
    <div class="badge mono">Juego: ${CodigoJuego}</div>
    <div class="badge mono">Instructor: ${CodigoInstructor}</div>
    <div class="hr"></div>
    <strong>Link Instructor</strong>
    <div class="copyrow" style="margin-top:6px">
      <input value="${linkInstructor}" readonly>
      <button class="btn secondary" onclick="copy('${linkInstructor}')">Copiar</button>
    </div>
    <div class="hr"></div>
    <strong>Links por Grupo</strong>
  `;
  groups.forEach(g=>{
    const link = `${BASE_URL}?role=player&group=${encodeURIComponent(g.CodigoGrupo)}&game=${encodeURIComponent(CodigoJuego)}&client=${encodeURIComponent(cliente)}`;
    html += `
      <div class="copyrow" style="margin-top:6px">
        <div class="badge">G${g.i}</div>
        <input value="${link}" readonly>
        <button class="btn secondary" onclick="copy('${link}')">Copiar</button>
      </div>
    `;
  });
  $("#admOut").innerHTML = html;
}

/* ===== INSTRUCTOR DASHBOARD ===== */
function viewInstructor(){
  const code = ST.instructor.code || q("code");
  const game = ST.instructor.game || q("game");
  ST.instructor.code = code; ST.instructor.game = game;

  const root = el('div',{class:'card'});
  root.append(
    el('h3',{},'Panel Instructor'),
    el('div',{class:'muted'},`Juego ${game||'-'} ¬∑ Clave ${code||'-'}`),
    el('div',{class:'hr'}),

    // KPIs
    el('div',{class:'kpis',id:'kpis'},[
      kpi('Jugadas totales','k_total'),
      kpi('Switch ¬∑ √âxito','k_sw_rate'),
      kpi('Stay ¬∑ √âxito','k_st_rate'),
      kpi('√öltima actualizaci√≥n','k_last')
    ]),
    el('div',{class:'hr'}),

    // Chart
    el('div',{class:'card'},[
      el('h4',{},'√âxito por estrategia'),
      el('canvas',{id:'instChart',height:'120'})
    ]),
    el('div',{class:'hr'}),

    // Tabla
    el('div',{class:'card'},[
      el('h4',{},'√öltimas jugadas'),
      el('div',{id:'tableBox'}, tableSkeleton())
    ])
  );

  // Primer load + intervalo cada 10s
  loadInstructorData();
  clearInterval(ST.instructor.timer);
  ST.instructor.timer = setInterval(loadInstructorData, 10000);

  return root;
}

function kpi(title,id){ const box=el('div',{class:'kpi'}); box.append(el('h4',{},title), el('div',{id, class:'v'},'‚Äî')); return box; }
function tableSkeleton(){
  const tbl = el('table',{style:'width:100%;border-collapse:collapse'});
  tbl.innerHTML = `
    <thead>
      <tr>
        <th style="border-bottom:1px solid var(--line);padding:6px;text-align:left">Fecha</th>
        <th style="border-bottom:1px solid var(--line);padding:6px;text-align:left">Grupo</th>
        <th style="border-bottom:1px solid var(--line);padding:6px;text-align:left">Estrategia</th>
        <th style="border-bottom:1px solid var(--line);padding:6px;text-align:left">Resultado</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="4" style="padding:8px;color:var(--muted)"><span class="spinner"></span> Cargando‚Ä¶</td></tr></tbody>
  `;
  return tbl;
}

async function loadInstructorData(){
  const game = ST.instructor.game;
  // Dashboard (agregado por script)
  const dashRes = await fetch(SCRIPT_URL + "?sheet=dashboard").then(r=>r.json()).catch(()=>[]);
  const dashRow = Array.isArray(dashRes) ? dashRes.find(r => r.CodigoJuego === game) : null;

  // Links (para tabla de √∫ltimas jugadas)
  const linksRes = await fetch(SCRIPT_URL + "?sheet=links").then(r=>r.json()).catch(()=>[]);
  const plays = Array.isArray(linksRes) ? linksRes
    .filter(r => r.Accion==="PLAY" && r.CodigoJuego===game)
    .slice(-20).reverse() : [];

  // KPIs
  if(dashRow){
    const total = +dashRow.TotalJugadas || 0;
    const swRate = (+(dashRow.TasaExitoSwitch||0)*100).toFixed(0)+"%";
    const stRate = (+(dashRow.TasaExitoStay||0)*100).toFixed(0)+"%";
    $("#k_total").textContent = total;
    $("#k_sw_rate").textContent = swRate;
    $("#k_st_rate").textContent = stRate;
    $("#k_last").textContent = new Date().toLocaleTimeString();
    renderChart(+dashRow.TasaExitoSwitch||0, +dashRow.TasaExitoStay||0);
  }else{
    $("#k_total").textContent = "0";
    $("#k_sw_rate").textContent = "0%";
    $("#k_st_rate").textContent = "0%";
    $("#k_last").textContent = new Date().toLocaleTimeString();
    renderChart(0,0);
  }

  // Tabla
  const tbody = $("#rows");
  tbody.innerHTML = "";
  if(!plays.length){
    tbody.innerHTML = `<tr><td colspan="4" style="padding:8px;color:var(--muted)">Sin jugadas a√∫n.</td></tr>`;
  }else{
    plays.forEach(r=>{
      const tr = el('tr');
      const isWin = (r.Resultado||"").toUpperCase()==="WIN" || (r.Resultado||"").includes("GAN");
      tr.append(
        td(new Date(r.FechaRegistro).toLocaleString()),
        td(r.CodigoGrupo || "‚Äî"),
        td((r.Observacion||"").toUpperCase()),
        td(isWin? "‚úÖ WIN" : "‚ùå LOSE", isWin? 'color:#86efac' : 'color:#fca5a5')
      );
      tbody.append(tr);
    });
  }
}
function td(text, style=""){ const x=el('td',{style:`padding:6px;border-bottom:1px solid var(--line);${style}`}); x.textContent=text; return x; }

function renderChart(switchRate, stayRate){
  const ctx = $("#instChart").getContext("2d");
  if(ST.instructor.chart){ ST.instructor.chart.destroy(); }
  ST.instructor.chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Switch', 'Stay'],
      datasets: [{
        label: '% √âxito',
        data: [Math.round(switchRate*100), Math.round(stayRate*100)],
        backgroundColor: ['#22c55e','#60a5fa']
      }]
    },
    options: {
      responsive:true,
      scales:{ y:{min:0,max:100,ticks:{color:'#9fb3c8'}}},
      plugins:{ legend:{display:false}}
    }
  });
}

/* ===== PLAYER (JUEGO) ===== */
function viewPlayer(){
  // Lee params
  ST.player.game  = q("game");
  ST.player.group = q("group");
  ST.player.choice=null; ST.player.open=null; ST.player.finished=false;
  ST.player.prize = 1 + Math.floor(Math.random()*3);

  const box = el('div',{class:'card'});
  box.append(
    el('div',{class:'badge'},`Juego ${ST.player.game||'-'} ¬∑ Grupo ${ST.player.group||'-'}`),
    el('h3',{},'Eleg√≠ una puerta'),
    el('div',{class:'doors'},[
      doorBtn(1), doorBtn(2), doorBtn(3)
    ]),
    el('div',{id:'panel',class:'center muted',style:'margin-top:8px'},'Esperando tu elecci√≥n‚Ä¶'),
    el('div',{class:'actions'},[
      el('button',{id:'btnSwitch',class:'btn secondary',onclick:()=>finish('switch'),disabled:true},'Cambiar'),
      el('button',{id:'btnStay',class:'btn primary',onclick:()=>finish('stay'),disabled:true},'Mantener')
    ])
  );
  return box;
}
function doorBtn(n){
  return el('div',{id:`door${n}`,class:'door',onclick:()=>choose(n)},'üö™');
}
function choose(n){
  if(ST.player.choice || ST.player.finished) return;
  ST.player.choice = n;
  $("#panel").textContent = `Elegiste la puerta ${n}. El presentador abrir√° una puerta con cabra‚Ä¶`;

  // Presentador abre cabra
  const options = [1,2,3].filter(d => d!==ST.player.choice && d!==ST.player.prize);
  ST.player.open = options[Math.floor(Math.random()*options.length)];
  // Sonido cabra
  $("#sGoat").currentTime=0; $("#sGoat").play().catch(()=>{});

  // Actualizo UI
  for(let i=1;i<=3;i++){
    const d = $(`#door${i}`);
    if(i===ST.player.open){ d.textContent="üêê"; d.classList.add('disabled'); }
    else d.textContent="üö™";
  }
  $("#btnSwitch").disabled=false;
  $("#btnStay").disabled=false;
}
function finish(strategy){
  if(ST.player.finished) return;
  ST.player.finished=true;

  const finalDoor = (strategy==='switch')
    ? [1,2,3].find(d=>d!==ST.player.choice && d!==ST.player.open)
    : ST.player.choice;
  const isWin = (finalDoor === ST.player.prize);

  // Revelo
  for(let i=1;i<=3;i++){
    const d = $(`#door${i}`);
    d.classList.add('disabled');
    if(i===ST.player.prize){ d.textContent="üöó"; }
    else{ d.textContent="üêê"; }
  }

  // Sonidos
  if(isWin){ $("#sCar").play().catch(()=>{}); setTimeout(()=>$("#sWin").play().catch(()=>{}),400); }
  else { $("#sGoat").play().catch(()=>{}); setTimeout(()=>$("#sLose").play().catch(()=>{}),400); }

  $("#panel").innerHTML = isWin
    ? `<strong style="color:#86efac">¬°Ganaste el auto! üöó</strong>`
    : `<strong style="color:#fca5a5">Sali√≥ cabra üêê</strong>`;

  // Registro en Sheets
  fetch(SCRIPT_URL,{
    method:"POST",
    body: JSON.stringify({
      action:"PLAY",
      CodigoJuego: ST.player.game || "",
      Cliente: q("client") || "",
      CodigoInstructor: q("inst") || "", // (opcional si lo quer√©s pasar en el link)
      CodigoGrupo: ST.player.group || "",
      Resultado: isWin ? "WIN" : "LOSE",
      Observacion: strategy
    })
  });
}

/* ===== ROUTER ===== */
function boot(){
  const role = q("role");
  if(role==="instructor"){
    ST.role='instructor';
    mount( viewInstructor() );
    return;
  }
  if(role==="player"){
    ST.role='player';
    mount( viewPlayer() );
    return;
  }
  // default: admin login
  ST.role='admin';
  mount( viewAdminLogin() );
}
boot();
</script>
</body>
</html>
