<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dilema Monty Hall</title>
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#0f172a;color:#e5e7eb}
    .container{max-width:900px;margin:0 auto;padding:24px}
    .card{background:#111827;border-radius:12px;padding:20px;margin-bottom:20px}
    .title{font-size:24px;font-weight:bold;margin-bottom:10px}
    .btn{padding:10px 16px;border:none;border-radius:8px;background:#22d3ee;color:#001018;font-weight:bold;cursor:pointer}
    .btn:hover{background:#06b6d4}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1224;color:#e5e7eb;margin-bottom:10px}
    .slot{border:1px solid #334155;border-radius:10px;padding:10px;margin-bottom:10px}
    .ok{color:#22c55e;font-weight:bold}
    .error{color:#ef4444;font-weight:bold}
  </style>
</head>
<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <script>
    // ✅ Tu API real de Apps Script
    const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhZUwLER8QIvz6AsFEVlx8chXwFG4uwOnncS5CdccZG5gVTb1VYz56Tr8evnMI8YMBNA92oIsmd27LXOzrV1wl0TKEel7xEEUpsofwsRyTenUPJnfzXSsxbCczfkLpe1w_QZnkH-uUCROwQh7PRdd5sbin0KStunaPs-k1rEA67-H5TswojMn1ZKQVfcQR4__Zqq_8DdO7ZGY58JNBCqBet8Ies63Y494ZmAfxqpnkQMlH5KgjfXQ5OJfwDrQ3hwhtPvGT1EugvTNK1PTxoYTJX_QlxtQ&lib=MbvEgdkJk8FGt__vFllcuyzQM98uU350M";

    const ADMIN_PASS = "9090"; 
    const MAX_GROUPS = 5;

    const S = {
      route: route(),
      admin: { logged: false },
      game: null
    };

    function route(){
      const p = new URLSearchParams(location.search);
      const hash = location.hash.replace(/^#\/,'');
      const path = hash || (location.pathname === '/' ? '' : location.pathname.replace(/^\//,''));
      return { path, p };
    }
    window.addEventListener('hashchange', ()=>{ S.route = route(); render(); });

    function el(tag, props={}, children){
      const node=document.createElement(tag);
      for(const k in props){ 
        if(k==='class') node.className=props[k]; 
        else if(k==='style') node.setAttribute('style',props[k]); 
        else if(k.startsWith('on')) node[k]=props[k]; 
        else node.setAttribute(k, props[k]); 
      }
      if(children!==undefined){
        const arr=Array.isArray(children)?children:[children];
        arr.forEach(ch=>node.append(ch.nodeType?ch:document.createTextNode(ch)));
      }
      return node;
    }
    function input(ph,type='text',val=''){const i=el('input',{class:'input',placeholder:ph,type});i.value=val;return i;}

    async function fetchLinks(){
      const res = await fetch(API_URL+"?sheet=links");
      return res.json();
    }
    async function createLink(client, days=30){
      const token = Math.random().toString(36).substring(2,10).toUpperCase();
      const createdAt = new Date().toISOString();
      const expiresAt = new Date(Date.now()+days*24*60*60*1000).toISOString();

      const body = {
        id: Date.now(),
        cliente: client,
        token: token,
        fecha_creacion: createdAt,
        fecha_expiracion: expiresAt
      };

      await fetch(API_URL+"?sheet=links", {
        method:"POST",
        body: JSON.stringify(body),
        headers:{"Content-Type":"application/json"}
      });

      return body;
    }

    async function render(){
      const app = document.getElementById('app');
      const { path, p } = S.route;

      if(path === 'admin') return app.replaceChildren(await viewAdmin());
      if(path === 'game' || p.get('token')) return app.replaceChildren(await viewGame());
      app.replaceChildren(viewHome());
    }

    function viewHome(){
      return el('div',{class:'card'},[
        el('h1',{class:'title'},'Juego 3.0 – Sistema Integrado'),
        el('button',{class:'btn',onclick:()=>location.hash='#/admin'},'Ir al Admin')
      ]);
    }

    async function viewAdmin(){
      const c = el('div',{class:'card'});
      c.append(el('h2',{class:'title'},'Módulo Administrativo'));

      if(!S.admin.logged){
        const pass = input('Contraseña', 'password');
        const btn = el('button',{class:'btn',onclick:()=>{
          if(pass.value===ADMIN_PASS){ S.admin.logged=true; render(); }
          else alert('Contraseña incorrecta');
        }},'Ingresar');
        c.append(pass,btn);
        return c;
      }

      const name = input('Cliente / Empresa');
      const btnCreate = el('button',{class:'btn',onclick:async()=>{
        const n = (name.value||'Cliente');
        const link = await createLink(n,30);
        render();
        const url = `${location.origin}${location.pathname}?token=${link.token}#/game`;
        navigator.clipboard.writeText(url);
        alert(`Link creado y copiado al portapapeles:\n${url}`);
      }},'Generar link');

      c.append(name,btnCreate);

      const links = await fetchLinks();
      links.forEach(l=>{
        const url = `${location.origin}${location.pathname}?token=${l.token}#/game`;
        const box = el('div',{class:'slot'},[
          el('div',{},`${l.cliente} – expira ${l.fecha_expiracion}`),
          el('a',{href:url,target:'_blank'},url),
          el('button',{class:'btn',onclick:()=>navigator.clipboard.writeText(url)},'Copiar link')
        ]);
        c.append(box);
      });

      return c;
    }

    async function viewGame(){
      const token = S.route.p.get('token');
      if(!token) return el('div',{class:'card'},'Falta token');
      const links = await fetchLinks();
      const link = links.find(l=>l.token===token);
      if(!link) return el('div',{class:'card error'},'❌ Token inválido');

      if(!S.game) S.game={token,step:'landing',groups:[]};

      const g=S.game;

      if(g.step==='landing') return el('div',{class:'card'},[
        el('h2',{},`Bienvenido ${link.cliente}`),
        el('button',{class:'btn',onclick:()=>{g.step='slots';render();}},'Iniciar Partida')
      ]);

      if(g.step==='slots'){
        const grid=el('div');
        for(let i=0;i<MAX_GROUPS;i++){
          const gp=g.groups[i]||{joined:false};
          if(gp.joined){
            grid.append(el('div',{class:'slot'},[
              el('strong',{},gp.name),
              el('div',{},gp.code)
            ]));
          }else{
            const n=input('Nombre equipo');
            const c=input('Código');
            const btn=el('button',{class:'btn',onclick:()=>{
              if(!n.value||!c.value) return alert('Complete los campos');
              gp.name=n.value; gp.code=c.value; gp.joined=true;
              g.groups[i]=gp;
              render();
            }},'Entrar');
            grid.append(el('div',{class:'slot'},[n,c,btn]));
          }
        }
        const canStart=g.groups.filter(x=>x?.joined).length>=MAX_GROUPS;
        return el('div',{class:'card'},[
          el('h2',{},`Equipos dentro ${g.groups.filter(x=>x?.joined).length}/${MAX_GROUPS}`),
          grid,
          el('button',{class:'btn',disabled:!canStart,onclick:()=>{g.step='r0';render();}},canStart?'Comenzar Ronda 0':'Esperando…')
        ]);
      }

      if(g.step==='r0'){
        return el('div',{class:'card'},[
          el('h2',{},'Ronda 0 – Demo'),
          el('p',{},'Aquí irá la lógica del juego.')
        ]);
      }
    }

    render();
  </script>
</body>
</html>
