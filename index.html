<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dilema Monty Hall</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#0f172a; color:white; text-align:center; }
    h1 { margin-top:30px; }
    .card { background:#1e293b; margin:20px auto; padding:20px; border-radius:12px; max-width:500px; box-shadow:0 4px 10px rgba(0,0,0,0.5); }
    input, button { padding:10px; margin:8px; border-radius:6px; border:none; }
    button { cursor:pointer; font-weight:bold; }
    .btn-admin { background:#06b6d4; color:white; }
    .btn-instructor { background:#64748b; color:white; }
    .btn-jugador { background:#334155; color:white; }
    .puertas { display:flex; justify-content:center; margin:20px 0; }
    .puerta { width:100px; height:150px; background:#334155; margin:10px; display:flex; justify-content:center; align-items:center; font-size:24px; cursor:pointer; border-radius:8px; transition:0.3s; }
    .puerta:hover { background:#475569; }
    .noti { background:#22c55e; padding:8px; border-radius:6px; margin:10px auto; display:none; max-width:300px; }
    table { width:100%; margin-top:15px; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #475569; }
  </style>
</head>
<body>

<h1>Dilema Monty Hall</h1>
<div id="app"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz9-f1GUGlC8vuegt4ci3gXlGJ4QLqlUruj_CEQ0Jesl0qa0xCrskDzBQEmO1V8ckk/exec";
const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get("role");
const code = urlParams.get("code");
const group = urlParams.get("group");

// ---------- Vista Inicial ----------
function renderInicio(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Bienvenido</h2>
      <p>Este simulador requiere un link v√°lido.</p>
    </div>`;
}

// ---------- Admin ----------
function renderAdmin(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>M√≥dulo Administrador</h2>
      <input id="cliente" placeholder="Nombre Cliente"><br>
      <input id="grupos" type="number" min="1" max="10" placeholder="Cantidad de grupos"><br>
      <button class="btn-admin" onclick="generarPartidas()">Generar Links</button>
      <div id="links"></div>
      <div id="noti" class="noti"></div>
    </div>`;
}

async function generarPartidas(){
  const cliente = document.getElementById("cliente").value;
  const grupos = parseInt(document.getElementById("grupos").value)||1;
  let out = "";
  for(let g=1; g<=grupos; g++){
    const juego = "J-"+Math.random().toString(36).substr(2,5).toUpperCase();
    const instr = "I-"+Math.random().toString(36).substr(2,5).toUpperCase();
    const fecha = new Date();
    const expira = new Date(Date.now()+30*24*60*60*1000);
    // Guardar
    await fetch(API_URL,{method:"POST",body:JSON.stringify({
      action:"SAVE_GAME",CodigoJuego:juego,Cliente:cliente,Grupo:g,
      FechaCreacion:fecha,FechaExpira:expira,CodigoInstructor:instr
    })});
    // Links
    const lInstr = `${location.origin}${location.pathname}?role=instructor&code=${instr}&group=${g}&juego=${juego}`;
    const lJug = `${location.origin}${location.pathname}?role=jugador&group=${g}&juego=${juego}`;
    out += `<p><b>Grupo ${g}</b><br>
      Instructor: <a href="${lInstr}" target="_blank">${lInstr}</a><br>
      Jugadores: <a href="${lJug}" target="_blank">${lJug}</a>
      <button onclick="copiar('${lJug}')">Copiar Jugadores</button>
    </p>`;
  }
  document.getElementById("links").innerHTML = out;
}

function copiar(txt){
  navigator.clipboard.writeText(txt);
  const n = document.getElementById("noti");
  n.innerText="‚úÖ Link copiado";
  n.style.display="block";
  setTimeout(()=>n.style.display="none",2000);
}

// ---------- Jugador ----------
function renderJugador(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Elige una puerta</h2>
      <div class="puertas">
        <div class="puerta" onclick="jugar(1)">1</div>
        <div class="puerta" onclick="jugar(2)">2</div>
        <div class="puerta" onclick="jugar(3)">3</div>
      </div>
      <div id="resultado"></div>
    </div>`;
}

function jugar(sel){
  const premio = Math.ceil(Math.random()*3);
  let reveal;
  do { reveal=Math.ceil(Math.random()*3); } while(reveal===sel||reveal===premio);
  document.getElementById("resultado").innerHTML = `
    <p>Se abre la puerta ${reveal} y aparece una cabra üêê</p>
    <button onclick="resolver(${sel},${premio},true)">Cambiar</button>
    <button onclick="resolver(${sel},${premio},false)">Quedarme</button>`;
}

function resolver(sel,premio,cambio){
  let final = cambio ? [1,2,3].find(n=>n!==sel&&n!==premio) : sel;
  let win = final===premio;
  document.getElementById("resultado").innerHTML = win ? 
    `<h3>üéâ Ganaste el Auto üöó</h3>` : `<h3>üò¢ Te toc√≥ una Cabra üêê</h3>`;
  fetch(API_URL,{method:"POST",body:JSON.stringify({
    action:"PLAY",CodigoJuego:urlParams.get("juego"),Cliente:"X",
    Grupo:group,Observacion:cambio?"switch":"stay",Resultado:win?"WIN":"LOSE"
  })});
}

// ---------- Instructor ----------
function renderInstructor(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>Dashboard Instructor</h2>
      <p>C√≥digo: ${code}</p>
      <div id="dash">Cargando...</div>
    </div>`;
  cargarDashboard();
  setInterval(cargarDashboard,10000);
}

async function cargarDashboard(){
  const res = await fetch(API_URL);
  const data = await res.json();
  if(!data.ok) return;
  const juegos = data.data.filter(r=>r.CodigoJuego===urlParams.get("juego") && r.Grupo==group);
  if(juegos.length===0){ document.getElementById("dash").innerHTML="Sin datos"; return;}
  const j = juegos[0];
  document.getElementById("dash").innerHTML=`
    <table>
      <tr><th>Total Jugadas</th><td>${j.TotalJugadas}</td></tr>
      <tr><th>Switch Ganadas</th><td>${j.SwitchGanadas}</td></tr>
      <tr><th>Switch Perdidas</th><td>${j.SwitchPerdidas}</td></tr>
      <tr><th>Stay Ganadas</th><td>${j.StayGanadas}</td></tr>
      <tr><th>Stay Perdidas</th><td>${j.StayPerdidas}</td></tr>
      <tr><th>Tasa √âxito Switch</th><td>${(j.TasaExitoSwitch*100).toFixed(1)}%</td></tr>
      <tr><th>Tasa √âxito Stay</th><td>${(j.TasaExitoStay*100).toFixed(1)}%</td></tr>
    </table>`;
}

// ---------- Router ----------
if(role==="admin"){ renderAdmin(); }
else if(role==="jugador"){ renderJugador(); }
else if(role==="instructor"){ renderInstructor(); }
else { renderInicio(); }
</script>
</body>
</html>
